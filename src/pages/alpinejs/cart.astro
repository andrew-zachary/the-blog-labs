---
import Base from "../../layouts/base.astro";

import CartAdd from "../../components/icon-cart-add.astro";
import Cart from "../../components/icon-cart.astro";
import Modal from "../../components/modal.astro";
import Plus from "../../components/icon-plus-.astro";
import Remove from "../../components/icon-remove.astro";
---

<style lang="scss" is:global>
    #products-list {

        button {
            width: 5rem;
            height: 5rem;
        }

        ul {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(28rem, 31rem));
            justify-content: center;
            gap: 1rem 1rem;

            li {
                box-shadow: 0px 0px 10px -3px #1e3a8a;
            }
        }
    }

    #cart {
        height: 7.4rem;

        button {

            .svg-box {

                max-width: 5rem;
                max-height: 5rem;
            }
        }
    }

    #cart-modal {

        #cart-products-list {

            button {
                max-width: 3rem;
                max-height: 3rem;
            }

            li:last-child {
                border: unset;
            }
        }
    }

    .animate__animated {
        animation-duration: 1s;
        animation-fill-mode: both;
    }

    @keyframes jello {
        from,
        11.1%,
        to {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }

        22.2% {
            -webkit-transform: skewX(-12.5deg) skewY(-12.5deg);
            transform: skewX(-12.5deg) skewY(-12.5deg);
        }

        33.3% {
            -webkit-transform: skewX(6.25deg) skewY(6.25deg);
            transform: skewX(6.25deg) skewY(6.25deg);
        }

        44.4% {
            -webkit-transform: skewX(-3.125deg) skewY(-3.125deg);
            transform: skewX(-3.125deg) skewY(-3.125deg);
        }

        55.5% {
            -webkit-transform: skewX(1.5625deg) skewY(1.5625deg);
            transform: skewX(1.5625deg) skewY(1.5625deg);
        }

        66.6% {
            -webkit-transform: skewX(-0.78125deg) skewY(-0.78125deg);
            transform: skewX(-0.78125deg) skewY(-0.78125deg);
        }

        77.7% {
            -webkit-transform: skewX(0.390625deg) skewY(0.390625deg);
            transform: skewX(0.390625deg) skewY(0.390625deg);
        }

        88.8% {
            -webkit-transform: skewX(-0.1953125deg) skewY(-0.1953125deg);
            transform: skewX(-0.1953125deg) skewY(-0.1953125deg);
        }
    }

    .animate__jello {
        animation-name: jello;
        transform-origin: center;
    }

</style>

<script>
    import alpine from 'alpinejs';

    alpine.data('products', () => ({
        items: [
            {id:1, name:'this is product 1', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:10},
            {id:2, name:'product 2', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:20},
            {id:3, name:'product 3', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:30},
            {id:4, name:'product 4', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:40},
            {id:5, name:'product 5', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:50},
            {id:6, name:'product 6', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:10},
            {id:7, name:'product 7', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:20},
            {id:8, name:'product 8', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:30},
            {id:9, name:'product 9', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:40},
            {id:10, name:'product 10', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:50},
            {id:11, name:'product 11', desc:'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Distinctio nihil vitae est cupiditate, praesentium ipsam.', price:10},
        ]
    }));

    alpine.store('cart', {
        items: [],
        total: 0,
        count: 0,
        add(newItem) {

            const cartItem = this.items.find(item => item.id === newItem.id);

            if(!cartItem) {
                this.items.push({...newItem, count: 1, total: newItem.price });
                this.total += newItem.price;
                this.count += 1;
            } else
                this.items = this.items.map((item) => {
                    if(item.id !== newItem.id) return item;
                    item.count += 1;
                    item.total = item.price * item.count;
                    this.total += item.price;
                    this.count += 1;
                    return item;
                });

        },
        remove(id) {

            const cartItem = this.items.find(item => item.id === id);

            if(cartItem.count > 1)
                this.items = this.items.map((item) => {
                    if(item.id !== id) return item;
                    item.count -= 1;
                    item.total = item.price * item.count;
                    this.total -= item.price;
                    this.count -= 1;
                    return item;
                });
            else if(cartItem.count === 1) {
                this.items = this.items.filter((item) => item.id !== id);
                this.total -= cartItem.price;
                this.count -= 1;
            }
        }
    });

    alpine.data('cart_container', () => ({
        open: false,
        init() {
            this.$refs.cartBox.addEventListener('animationend', () => {
                this.$refs.cartBox.classList.remove('animate__jello');
            });
            this.$watch('$store.cart.count', () => this.$refs.cartBox.classList.add('animate__jello'));
        },
        toggle(){
            this.open = !this.open;
            if(this.open) {
                document.body.style.overflow = 'hidden'; 
            } else {
                document.body.style.overflow = 'auto';
            }
        }
    }));

    alpine.start();
</script>

<Base>

    <!-- products list -->
    <div id="products-list" class="max-w-lg mx-auto" x-data='products'>

        <ul class="p-4">
            <template x-for="(item, index) in items" x-key="index">
                <li class="p-4">
                    <img src="/350x450.png" alt="">
                    <h1 class="mt-4 text-6xl text-blue-900 font-bold capitalize" x-text="item.name"></h1>
                    <h2 class="mt-8 text-4xl font-regular">Lorem ipsum dolor, sit amet consectetur adipisicing elit.</h2>
                    <p class="mt-4 text-4xl font-bold" x-text="'$' + ' ' + item.price"></p>
                    <div class="ctrl mt-8 flex justify-end">
                        <button type="button" @click="$store.cart.add(item)">
                            <CartAdd fill="#1e3a8a" />
                        </button>
                    </div>
                </li>
            </template>
        </ul>

    </div>
    <!-- products list -->

    <!-- the cart -->
    <div id="cart" x-data="cart_container">

        <button
            type="button"
            class="fixed z-30 bottom-0 right-0
            rounded-xl
            mx-8 my-4 
            flex items-center
            bg-blue-900 text-white
            border-2 border-blue-900"
            @click="toggle()"
        >
            <div 
                class="p-4
                rounded-tl-xl rounded-bl-xl
                bg-white
                text-blue-900
                flex items-center justify-center"
            >
                <span class="text-6xl font-bold" x-text="$store.cart.count"></span>
                <span class="text-6xl mx-2">x</span>
                <div class="svg-box animate__animated animate__jello" x-ref="cartBox">
                    <Cart fill="#1e3a8a" />
                </div>
            </div>
            <div class="flex items-center text-center px-4">
                <span class="inline-block text-6xl font-bold">$</span>
                <span class="inline-block text-6xl font-bold" x-text="$store.cart.total"></span>
            </div>
        </button>

        <template x-teleport="body">
            <Modal>
                <h1 class="text-white text-4xl capitalize text-center" x-show="$store.cart.items.length === 0">cart is empty</h1>
                <ul id="cart-products-list" x-show="$store.cart.items.length > 0">
                    <template x-for="(item, index) in $store.cart.items" x-key="index">
                        <li class="p-4 my-12 text-white border-b border-white">
                            <div class="text-6xl font-bold capitalize" x-text="item.name"></div>
                            <div class="mt-4 text-4xl text-center font-bold" x-text="item.count + ' for ' + ' $ ' + item.total"></div>
                            <div class="mt-4 flex justify-around max-w-xs mx-auto">
                                <button type="button" @click="$store.cart.remove(item.id)">
                                    <Remove fill="white" />
                                </button>
                                <button type="button" @click="$store.cart.add(item)">
                                    <Plus fill="white" />
                                </button>
                            </div>
                        </li>
                    </template>
                </ul>
            </Modal>
        </template>

    </div>
    <!-- the cart -->

</Base>
